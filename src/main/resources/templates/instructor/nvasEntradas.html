<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org">

<head th:insert="~{/instructor/templates_instructor.html::head}">
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
	<link rel="stylesheet" th:href="@{/css/instructor.css}">
</head>

<body class="index-page">

	<!-- Video de fondo -->
	<div class="video-background">
		<div class="video-overlay"></div>
	</div>

	<!-- Para SIDEBAR en celu -->
	<button class="sidebar-toggle" id="sidebarToggle">
		<i class="bi bi-list"></i>
	</button>

	<div class="dashboard-container">
		<!-- SIDEBAR -->
		<aside class="sidebar" id="sidebar">
			<div class="sidebar-header">
				<div class="logo-container">
					<i class="bi bi-easel2-fill logo-icon"></i>
					<h2>TECH<span>ACCESS</span></h2>
				</div>
				<p>SENA - CIMM CIUDADELA</p>
			</div>

			<!-- Perfil de usuario en sidebar -->
			<div class="user-profile-sidebar">
				<div class="avatar-container">
					<img th:src="@{/images/instructor.png}" alt="Instructor" class="user-avatar">
					<span class="online-status"></span>
				</div>
				<div class="user-info text-center">
					<h4 th:text="${usuario.nombre} ?: 'Instructor'">Instructor</h4>
					<p class="user-role"><b>Área:</b> Mecánica</p>
					<span class="user-status">Activo</span>
				</div>
			</div>

			<!-- Menú de navegación -->
			<ul class="sidebar-nav">
				<li>
					<a th:href="@{/instructor/nvasEntradas}" class="active cargando-btn"
						data-mensaje="Cargando últimas entradas...">
						<div class="menu-icon-container">
							<i class="bi bi-house-door"></i>
						</div>
						<span class="menu-text">Últimas Entradas</span>
						<span class="menu-badge" th:text="${entradasHoy ?: 0}">0</span>
					</a>
				</li>
				<li>
					<a th:href="@{/instructor/grupos}" class="cargando-btn" data-mensaje="Cargando grupos...">
						<div class="menu-icon-container">
							<i class="bi bi-people"></i>
						</div>
						<span class="menu-text">Grupos</span>
						<span class="menu-badge" th:text="${gruposActivos ?: 0}">0</span>
					</a>
				</li>
				<li>
					<a th:href="@{/instructor/reportes}" class="cargando-btn" data-mensaje="Generando reportes...">
						<div class="menu-icon-container">
							<i class="bi bi-clipboard-data"></i>
						</div>
						<span class="menu-text">Reportes</span>
						<span class="menu-indicator">
							<i class="bi bi-chevron-right"></i>
						</span>
					</a>
				</li>
			</ul>

			<!-- Resumen rápido -->
			<div class="sidebar-summary">
				<div class="summary-header">
					<i class="bi bi-graph-up"></i>
					<h5>Resumen Hoy</h5>
				</div>
				<div class="summary-stats">
					<div class="summary-item">
						<div class="summary-info">
							<i class="bi bi-person-check summary-icon present"></i>
							<span>Presentes</span>
						</div>
						<span class="summary-value text-accent" th:text="${entradasHoy ?: 0}">0</span>
					</div>
					<div class="summary-item">
						<div class="summary-info">
							<i class="bi bi-people summary-icon total"></i>
							<span>Total</span>
						</div>
						<span class="summary-value" th:text="${totalAprendices ?: 0}">0</span>
					</div>
					<div class="summary-item">
						<div class="summary-info">
							<i class="bi bi-exclamation-triangle summary-icon alert"></i>
							<span>Alertas</span>
						</div>
						<span class="summary-value text-warning" th:text="${alertas ?: 0}">0</span>
					</div>
				</div>
			</div>
		</aside>

		<!-- CONTENIDO PRINCIPAL -->
		<main class="main-content" id="mainContent">
			<!-- Encabezado superior -->
			<header class="top-header">
				<div class="page-title">
					<div class="welcome-container">
						<h1 class="welcome-text">
							<span class="greeting">Últimas Entradas</span>
							<span class="user-name" th:text="${usuario.nombre} ?: 'Instructor'">Instructor</span>
						</h1>
						<p class="welcome-subtitle">
							<i class="bi bi-clock-history me-2"></i>
							<span id="currentDateTime"></span>
						</p>
					</div>
				</div>

				<div class="header-actions">
					<!-- Búsqueda rápida -->
					<div class="search-container">
						<i class="bi bi-search search-icon"></i>
						<input type="text" class="search-input" placeholder="Buscar aprendiz...">
					</div>

					<!-- Notificaciones -->
					<div class="notification-bell" id="notificationBell">
						<i class="bi bi-bell"></i>
						<span class="notification-count" th:text="${alertas ?: 0}">0</span>
						<div class="notification-pulse"></div>
					</div>

					<!-- Usuario dropdown -->
					<div class="user-dropdown dropdown">
						<a class="d-flex align-items-center text-decoration-none" dropdown-toggle
							data-bs-toggle="dropdown">
							<div class="user-avatar-mini">
								<img th:src="@{/images/instructor.png}" alt="Instructor">
							</div>
							<div class="user-info-mini">
								<span class="user-name-mini"
									th:text="${usuario.nombre} ?: 'Instructor'">Instructor</span>
								<span class="user-role-mini">Instructor</span>
							</div>
							<i class="bi bi-chevron-down dropdown-arrow"></i>
						</a>
						<ul class="dropdown-menu dropdown-menu-end">
							<li>
								<a class="dropdown-item" href="#" id="perfil-link">
									<i class="bi bi-person me-2"></i>Mi Perfil
								</a>
							</li>
							<li>
								<a class="dropdown-item" href="#">
									<i class="bi bi-gear me-2"></i>Configuración
								</a>
							</li>
							<li>
								<hr class="dropdown-divider">
							</li>
							<li>
								<a class="dropdown-item" th:href="@{/logout}" id="logout-link">
									<i class="bi bi-box-arrow-right me-2"></i>Cerrar sesión
								</a>
							</li>
						</ul>
					</div>
				</div>
			</header>

			<!-- Widgets -->
			<div class="quick-widgets">
				<div class="quick-widget">
					<div class="widget-icon schedule">
						<i class="bi bi-door-open"></i>
					</div>
					<div class="widget-content">
						<span class="widget-value" th:text="${accesos != null ? accesos.size() : 0}">0</span>
						<span class="widget-label">Registros Hoy</span>
					</div>
				</div>

				<div class="quick-widget">
					<div class="widget-icon next-class">
						<i class="bi bi-person-check"></i>
					</div>
					<div class="widget-content">
						<span class="widget-value" th:text="${entradasHoy ?: 0}">0</span>
						<span class="widget-label">Presentes</span>
					</div>
				</div>
			</div>

			<!-- Contenido principal -->
			<div class="content-section">
				<!-- Panel de entradas -->
				<div class="section-card glassmorphism" style="grid-column: 1 / -1;">
					<div class="section-header">
						<div class="section-title">
							<div class="section-icon activity">
								<i class="bi bi-clock-history"></i>
							</div>
							<div>
								<h3>Últimas Entradas</h3>
								<p class="section-subtitle" th:if="${accesos != null and !accesos.empty}"
									th:text="'Total de registros: ' + ${accesos.size()}">
									Registros de entradas recientes
								</p>
								<p class="section-subtitle" th:if="${accesos == null or accesos.empty}">
									No hay registros disponibles
								</p>
							</div>
						</div>
						<a th:href="@{/instructor/nvasEntradas}" class="view-all-link">
							<i class="bi bi-arrow-clockwise me-1"></i> Actualizar
						</a>
					</div>

					<div class="section-body">
						<!-- Mostrar TABLA si hay datos -->
						<div th:if="${accesos != null and !accesos.empty}">
							<div class="table-responsive">
								<table class="table table-hover align-middle mb-0" style="color: white;">
									<thead class="table-primary" style="background: rgba(12, 45, 72, 0.7);">
										<tr>
											<th class="border-0">
												<i class="bi bi-person me-1"></i> Estudiante
											</th>
											<!--th class="border-0">
                                                <i class="bi bi-geo-alt me-1"></i> Área
                                            </th-->
											<th class="border-0">
												<i class="bi bi-calendar me-1"></i> Hora Ingreso
											</th>
											<th class="border-0">
												<i class="bi bi-info-circle me-1"></i> Estado
											</th>
											<!--th class="border-0 text-center">
                                                <i class="bi bi-gear me-1"></i> Acciones
                                            </th-->
										</tr>
									</thead>
									<tbody>
										<tr th:each="entrada : ${accesos}" class="border-bottom"
											style="border-color: rgba(255, 255, 255, 0.1);">
											<td class="fw-medium text-light"
												th:text="${entrada.usuario?.nombre} ?: 'NN'">
												Estudiante
											</td>
											<!--td th:text="${entrada.usuario?.rol} ?: 'N/A'">
                                                Área
                                            </td-->
											<!--td th:text="${entrada.areaJobs?.nomArea} ?: 'N/A'">
                                                Área
                                            </td-->
											<td>
												<span class="text-light small" th:text="${entrada.horaIngreso}">
													EntradaRegistro
												</span>
												<br>
												<!--span class="fw-medium"
                                                    th:text="${#dates.format(entrada.horaIngreso, 'HH:mm')}">
                                                    Hora
                                                </span-->
											</td>
											<td>
												<span th:if="${entrada.estadoPermanencia?.idestadoPermanencia == 1}"
													class="badge bg-success bg-opacity-25 text-success px-3 py-2 border border-success">
													<i class="bi bi-check-circle me-1"></i> Presente
												</span>
												<span th:if="${entrada.estadoPermanencia?.idestadoPermanencia == 2}"
													class="badge bg-dark bg-opacity-25 text-muted px-3 py-2 border border-muted">
													<i class="bi bi-x-circle me-1"></i> Ausente
												</span>
												<!--span
                                                    th:if="${entrada.estadoPermanencia?.nombre != 'Presente' and entrada.estadoPermanencia?.nombre != 'Ausente'}"
                                                    class="badge bg-secondary bg-opacity-25 text-secondary px-3 py-2 border border-secondary">
                                                    <i class="bi bi-question-circle me-1"></i>
                                                    <span
                                                        th:text="${entrada.estadoPermanencia?.nombre} ?: 'No definido'"></span>
                                                </span-->
											</td>
											<!--td class="text-center">
                                                <div class="btn-group btn-group-sm" role="group">
                                                    <a th:href="@{'/acceso/editar/' + ${entrada.idacceso}}"
                                                        class="btn btn-outline-info" title="Editar entrada">
                                                        <i class="bi bi-pencil-square"></i>
                                                    </a>
                                                    <a th:href="@{'/acceso/eliminar/' + ${entrada.idacceso}}"
                                                        class="btn btn-outline-secondary"
                                                        onclick="return confirm('¿Seguro que deseas eliminar esta entrada?');"
                                                        title="Eliminar entrada">
                                                        <i class="bi bi-trash"></i>
                                                    </a>
                                                </div>
                                            </td-->
										</tr>
									</tbody>
								</table>
							</div>

							<!-- Contador de estados -->
							<div class="mt-4 d-flex justify-content-between align-items-center">
								<small class="text-muted">
									<i class="bi bi-info-circle me-1"></i>
									Mostrando <strong class="text-light" th:text="${accesos.size()}">0</strong>
									registros
								</small>
								<small class="text-muted">
									<strong>Última actualización:</strong>
									<span class="text-light" th:text="${#dates.createNow()}">Ahora</span>
								</small>
							</div>
						</div>

						<!-- Mostrar ALERTA si no hay datos -->
						<div th:if="${accesos != null and accesos.empty}" class="text-center py-5">
							<div class="empty-state">
								<div class="empty-icon">
									<i class="bi bi-inbox text-info"></i>
								</div>
								<h4 class="text-info">No hay registros de entradas</h4>
								<p class="text-muted">
									No se encontraron entradas recientes en el sistema.
								</p>
								<div class="mt-3">
									<small class="text-muted">
										<i class="bi bi-info-circle me-1"></i>
										Las entradas se actualizarán si se registra el acceso de aprendices a las
										instalaciones
									</small>
								</div>
							</div>
						</div>

						<!-- Mostrar MENSAJE INICIAL si no se ha cargado nada -->
						<div th:if="${accesos == null}" class="text-center py-5">
							<div class="empty-state">
								<div class="empty-icon">
									<i class="bi bi-house text-success"></i>
								</div>
								<h4 class="text-success">Últimas Entradas</h4>
								<p class="text-muted">
									Seleccione "Últimas Entradas" en el menú lateral para cargar los registros
									recientes.
								</p>
							</div>
						</div>
					</div>
				</div>
			</div>
		</main>
	</div>

	<!-- Footer -->
	<div th:insert="~{/templates_usuario.html::footer}"></div>

	<!-- Archivos JS -->
	<div th:insert="~{/templates_usuario.html::jsFiles}"></div>

	<!-- SweetAlerts Scripts -->
	<script th:inline="javascript">
		/*<![CDATA[*/
		// Variables globales desde Thymeleaf
		const usuarioNombre = /*[[${usuario.nombre}]]*/ 'Instructor';
		const usuarioEmail = /*[[${usuario.email}]]*/ 'instructor@sena.edu.co';
		const alertasCount = /*[[${alertas}]]*/ 0;
		const totalAprendices = /*[[${totalAprendices}]]*/ 0;
		const accesosCount = /*[[${accesos != null ? accesos.size() : 0}]]*/ 0;

		// Actualizar fecha y hora
		function updateDateTime() {
			const now = new Date();
			const options = {
				weekday: 'long',
				year: 'numeric',
				month: 'long',
				day: 'numeric',
				hour: '2-digit',
				minute: '2-digit'
			};
			const dateTimeStr = now.toLocaleDateString('es-ES', options);
			document.getElementById('currentDateTime').textContent = dateTimeStr;
		}

		// Actualizar cada minuto
		updateDateTime();
		setInterval(updateDateTime, 60000);

		// Toggle sidebar en móvil
		const sidebarToggle = document.getElementById('sidebarToggle');
		const sidebar = document.getElementById('sidebar');
		const mainContent = document.getElementById('mainContent');

		if (sidebarToggle && sidebar) {
			sidebarToggle.addEventListener('click', function (e) {
				e.stopPropagation();
				sidebar.classList.toggle('active');
			});

			// Cerrar sidebar al hacer clic fuera en móvil
			document.addEventListener('click', function (event) {
				if (window.innerWidth <= 768 &&
					sidebar.classList.contains('active') &&
					!sidebar.contains(event.target) &&
					!sidebarToggle.contains(event.target)) {
					sidebar.classList.remove('active');
				}
			});
		}

		// Función para mostrar carga
		function cargando(mensaje) {
			if (typeof Swal !== 'undefined') {
				Swal.fire({
					title: mensaje,
					allowOutsideClick: false,
					showConfirmButton: false,
					backdrop: 'rgba(0, 0, 0, 0.4)',
					didOpen: () => {
						Swal.showLoading();
					}
				});

				// Cierre automático tras 2 segundos
				setTimeout(() => {
					if (Swal && Swal.isVisible()) {
						Swal.close();
					}
				}, 2000);
			}
		}

		// Confirmar logout
		function confirmarLogout(event) {
			event.preventDefault();

			if (typeof Swal !== 'undefined') {
				Swal.fire({
					title: '¿Cerrar sesión?',
					text: "¿Estás seguro de que quieres salir del sistema?",
					icon: 'question',
					showCancelButton: true,
					confirmButtonColor: '#0c2d48',
					cancelButtonColor: '#6c757d',
					confirmButtonText: 'Sí, salir',
					cancelButtonText: 'Cancelar',
					backdrop: 'rgba(0, 0, 0, 0.4)'
				}).then((result) => {
					if (result.isConfirmed) {
						window.location.href = '/logout';
					}
				});
			} else {
				if (confirm('¿Estás seguro de que quieres cerrar sesión?')) {
					window.location.href = '/logout';
				}
			}
		}

		// Mostrar perfil
		function mostrarPerfil() {
			if (typeof Swal !== 'undefined') {
				Swal.fire({
					title: 'Mi Perfil',
					html: `
                        <div class="profile-modal">
                            <div class="profile-header">
                                <img src="/images/instructor.png" alt="Instructor" class="profile-avatar">
                                <div class="profile-status online"></div>
                            </div>
                            <div class="profile-info">
                                <div class="info-item">
                                    <i class="bi bi-person"></i>
                                    <div>
                                        <span class="info-label">Nombre</span>
                                        <span class="info-value">${usuarioNombre}</span>
                                    </div>
                                </div>
                                <div class="info-item">
                                    <i class="bi bi-envelope"></i>
                                    <div>
                                        <span class="info-label">Email</span>
                                        <span class="info-value">${usuarioEmail}</span>
                                    </div>
                                </div>
                                <div class="info-item">
                                    <i class="bi bi-briefcase"></i>
                                    <div>
                                        <span class="info-label">Área</span>
                                        <span class="info-value">Mecánica</span>
                                    </div>
                                </div>
                                <div class="info-item">
                                    <i class="bi bi-door-open"></i>
                                    <div>
                                        <span class="info-label">Entradas Hoy</span>
                                        <span class="info-value">${accesosCount}</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `,
					icon: 'info',
					confirmButtonColor: '#0c2d48',
					confirmButtonText: 'Entendido',
					backdrop: 'rgba(0, 0, 0, 0.4)',
					showCloseButton: true
				});
			} else {
				alert(`Perfil:\nNombre: ${usuarioNombre}\nEmail: ${usuarioEmail}\nÁrea: Mecánica\nEntradas: ${accesosCount}`);
			}
		}

		// Inicializar eventos
		document.addEventListener('DOMContentLoaded', function () {
			// Asignar evento a enlaces de perfil
			const perfilLink = document.getElementById('perfil-link');
			if (perfilLink) {
				perfilLink.addEventListener('click', function (e) {
					e.preventDefault();
					mostrarPerfil();
				});
			}

			// Asignar evento a enlaces de logout
			const logoutLink = document.getElementById('logout-link');
			if (logoutLink) {
				logoutLink.addEventListener('click', confirmarLogout);
			}

			// Asignar eventos a botones de carga
			const cargandoButtons = document.querySelectorAll('.cargando-btn');
			cargandoButtons.forEach(button => {
				button.addEventListener('click', function (e) {
					const mensaje = this.getAttribute('data-mensaje') || 'Cargando...';
					cargando(mensaje);
				});
			});

			// Mostrar alerta de bienvenida
			setTimeout(() => {
				if (typeof Swal !== 'undefined' && accesosCount > 0) {
					Swal.fire({
						title: 'Entradas Cargadas',
						text: `Se han cargado ${accesosCount} registros de entrada correctamente.`,
						icon: 'success',
						confirmButtonColor: '#0c2d48',
						timer: 3000,
						timerProgressBar: true,
						toast: true,
						position: 'top-end',
						showConfirmButton: false,
						backdrop: false
					});
				}
			}, 1000);

			// Efecto de aparición para las tarjetas
			const statCards = document.querySelectorAll('.stat-card, .glassmorphism');
			statCards.forEach((card, index) => {
				setTimeout(() => {
					card.style.opacity = '1';
					card.style.transform = 'translateY(0)';
				}, index * 100);
			});
		});
		/*]]>*/
	</script>
</body>

</html>