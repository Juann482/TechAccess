<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org">

<head th:insert="~{/templates_usuario.html::head}">

	<meta charset="UTF-8">

	<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

	<style>
		/* va pa ESTILOS */
		.btn-outline-info {
			transition: all 0.3s ease !important;
			border-width: 2px !important;
		}

		.btn-outline-info:hover {
			transform: translateY(-2px) !important;
			box-shadow: 0 4px 12px rgba(0, 128, 192, 0.3) !important;
		}

		.access-card {
			transition: all 0.3s ease !important;
		}

		.access-card:hover {
			transform: translateY(-3px) !important;
			box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15) !important;
		}

		.user-nav {
			transition: all 0.3s ease !important;
		}

		.user-nav:hover {
			transform: translateY(-2px) !important;
			box-shadow: 0 6px 20px rgba(0, 0, 0, 0.1) !important;
		}

		/* MÉTRICAS */
		.metric-badge {
			background: linear-gradient(135deg, #0c2d48 0%, #1a4d6e 100%) !important;
			color: white !important;
			padding: 8px 15px !important;
			border-radius: 20px !important;
			font-weight: 600 !important;
			font-size: 0.9rem !important;
		}

		.stats-grid {
			display: grid !important;
			grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)) !important;
			gap: 1rem !important;
			margin-top: 1.5rem !important;
		}

		.stat-item {
			background: rgba(255, 255, 255, 0.9) !important;
			padding: 1.5rem !important;
			border-radius: 10px !important;
			text-align: center !important;
			box-shadow: 0 3px 10px rgba(0, 0, 0, 0.1) !important;
			transition: all 0.3s ease !important;
			border-left: 4px solid #0c2d48 !important;
		}

		.stat-item:hover {
			transform: translateY(-3px) !important;
			box-shadow: 0 6px 20px rgba(0, 0, 0, 0.15) !important;
		}

		.stat-number {
			font-size: 2.2rem !important;
			font-weight: bold !important;
			color: #0c2d48 !important;
			margin-bottom: 0.5rem !important;
		}

		.activity-list {
			max-height: 300px !important;
			overflow-y: auto !important;
		}

		.activity-item {
			padding: 0.75rem !important;
			border-left: 3px solid #28a745 !important;
			margin-bottom: 0.5rem !important;
			background: rgba(40, 167, 69, 0.05) !important;
			border-radius: 0 5px 5px 0 !important;
		}
	</style>
</head>

<body style="font-family: 'Segoe UI', sans-serif;" class="index-page">

	<header id="header" class="header d-flex align-items-center justify-content-between fixed-top w-100"
		style="background: linear-gradient(135deg, #0c2d48 0%, #1a4d6e 100%) !important; box-shadow: 0 5px 15px rgba(0,0,0,0.2) !important; z-index: 999;">
		<div class="container-fluid container-xl d-flex w-100 align-items-center justify-content-between">
			<h1 class="sitename m-0">
				<strong style="color:rgb(232, 248, 255);">TECH</strong>
				<span style="color:rgb(206, 239, 255);">ACCESS</span>
				<span style="color:rgb(255, 255, 255);">/</span>
				<span style="color:rgb(232, 248, 255);">SENA - CIMM CIUDADELA</span>
			</h1>

			<div class="user-profile d-flex align-items-center">
				<span class="me-2 text-white fw-bold" th:text="${usuario.nombre} ?: 'Instructor'">Instructor</span>
				<div class="dropdown">
					<a class="d-flex align-items-center text-decoration-none text-white" dropdown-toggle
						data-bs-toggle="dropdown" style="cursor: pointer;">
						<i class="bi bi-person-circle fs-4"></i>
					</a>
					<ul class="dropdown-menu dropdown-menu-end">
						<li><a class="dropdown-item" href="#" id="perfil-link">
								<i class="bi bi-person me-2"></i>Perfil
							</a></li>
						<li><a class="dropdown-item" th:href="@{/logout}" id="logout-link">
								<i class="bi bi-box-arrow-right me-2"></i>Cerrar sesión
							</a></li>
					</ul>
				</div>
			</div>
		</div>
	</header>

	<!-- Fondo de video -->
	<div class="video-container2 position-fixed top-0 start-0 w-100 h-100" style="z-index:-1;">
		<video class="video-background2 w-100 h-100 object-fit-cover" autoplay muted loop>
			<source src="https://videos.pexels.com/video-files/7946210/7946210-uhd_1440_2732_30fps.mp4">
			Error al cargar el video.
		</video>
	</div>

	<!-- Contenido principal -->
	<main class="main d-flex flex-column justify-content-between"
		style="background-color: rgba(0, 128, 192, 0.05); min-height: 100vh; margin-top: 100px;">

		<section class="section" style="background-color:rgba(235, 234, 231, 0.87)">
			<div class="container py-4">
				<div class="row">

					<!-- Panel lateral -->
					<div class="col-lg-3 mb-4">
						<div class="user-nav rounded shadow-sm p-3 bg-white text-center"
							style="background-color:rgba(255, 255, 255, 0.7)">
							<img th:src="@{/images/instructor.png}" alt="Instructor.img"
								style="width: 120px; border-radius: 50%; border: 2px solid rgb(0, 128, 192);">
							<h5 class="mt-2 mb-0" th:text="${usuario.nombre} ?: 'Instructor'">Instructor</h5>
							<small class="text-muted"><b>Área:</b> <span>Mecánica</span></small>
							<div class="mt-2">
								<span class="badge bg-success bg-opacity-10 text-success px-3 py-2">Activo</span>
							</div>

							<nav class="nav flex-column mt-4">
								<a th:href="@{/instructor/nvasEntradas}"
									class="btn btn-outline-info btn-sm mt-2 cargando-btn"
									data-mensaje="Cargando últimas entradas...">
									<i class="bi bi-house me-2 text-success"></i> Últimas Entradas
									<span class="metric-badge ms-2" th:text="${entradasHoy}">0</span>
								</a>
								<a th:href="@{/instructor/grupos}" class="btn btn-outline-info btn-sm mt-2 cargando-btn"
									data-mensaje="Cargando grupos...">
									<i class="bi bi-people me-2 text-success"></i> Grupos
									<span class="metric-badge ms-2" th:text="${gruposActivos}">0</span>
								</a>
								<a th:href="@{/instructor/reportes}"
									class="btn btn-outline-info btn-sm mt-2 cargando-btn"
									data-mensaje="Generando reportes...">
									<i class="bi bi-clipboard-data me-2 text-success"></i> Reportes
								</a>
							</nav>

							<!-- RESUMEN RÁPIDO -->
							<div class="mt-4 p-3 border rounded">
								<h6 class="text-muted mb-3"> Resumen Hoy</h6>
								<div class="row text-center">
									<div class="col-6 mb-2">
										<small class="text-muted">Presentes</small>
										<h6 class="mb-0 text-success" th:text="${entradasHoy}">0</h6>
									</div>
									<div class="col-6 mb-2">
										<small class="text-muted">Total</small>
										<h6 class="mb-0 text-primary" th:text="${totalAprendices}">0</h6>
									</div>
								</div>
							</div>
						</div>
					</div>

					<!-- Contenido principal dinámico -->
					<div class="col-lg-9">
						<div id="contenido" class="access-card bg-white shadow-sm rounded p-4" style="opacity: 0.9;">
							<h4 class="text-info">
								<i class="bi bi-info-circle me-2"></i><b> Bienvenido, </b>
								<span th:text="${usuario.nombre} ?: 'Instructor'">Instructor</span>
							</h4>
							<p class="text-muted">Sistema de control de acceso y gestión de aprendices</p>

							<!-- MÉTRICAS PRINCIPALES -->
							<div class="row g-3 mt-4">
								<div class="col-md-3 col-sm-6">
									<div class="stat-item">
										<i class="bi bi-people-fill fs-2 text-primary mb-2"></i>
										<div class="stat-number" th:text="${totalAprendices}">0</div>
										<small class="text-muted">Total Aprendices</small>
									</div>
								</div>
								<div class="col-md-3 col-sm-6">
									<div class="stat-item">
										<i class="bi bi-door-open fs-2 text-success mb-2"></i>
										<div class="stat-number" th:text="${entradasHoy}">0</div>
										<small class="text-muted">Entradas Hoy</small>
									</div>
								</div>
								<div class="col-md-3 col-sm-6">
									<div class="stat-item">
										<i class="bi bi-collection fs-2 text-warning mb-2"></i>
										<div class="stat-number" th:text="${gruposActivos}">0</div>
										<small class="text-muted">Grupos Activos</small>
									</div>
								</div>
								<div class="col-md-3 col-sm-6">
									<div class="stat-item">
										<i class="bi bi-exclamation-triangle fs-2 text-danger mb-2"></i>
										<div class="stat-number" th:text="${alertas}">0</div>
										<small class="text-muted">Por Verificar</small>
									</div>
								</div>
							</div>

							<!-- ACTIVIDAD RECIENTE -->
							<div class="row mt-4">
								<div class="col-md-8">
									<div class="card border-0 shadow-sm">
										<div class="card-header bg-white">
											<h6 class="mb-0">
												<i class="bi bi-activity me-2 text-success"></i>
												Actividad Reciente
											</h6>
										</div>
										<div class="card-body">
											<div th:if="${actividadReciente.empty}" class="text-center py-4">
												<i class="bi bi-inbox fs-1 text-muted"></i>
												<p class="text-muted mt-2">No hay actividad hoy</p>
											</div>

											<div th:unless="${actividadReciente.empty}" class="activity-list">
												<div th:each="acceso : ${actividadReciente}" class="activity-item">
													<div class="d-flex justify-content-between align-items-center">
														<div>
															<i class="bi bi-person-check text-success me-2"></i>
															<strong
																th:text="${acceso.usuario.nombre} ?: 'Usuario'">Aprendiz</strong>
															<small class="text-muted d-block">Ingreso registrado</small>
														</div>
														<small class="text-muted fw-bold"
															th:text="${#temporals.format(acceso.horaIngreso, 'HH:mm')}">
															14:30
														</small>
													</div>
												</div>
											</div>
										</div>
									</div>
								</div>

								<div class="col-md-4">
									<div class="card border-0 shadow-sm">
										<div class="card-header bg-white">
											<h6 class="mb-0">
												<i class="bi bi-bell me-2 text-warning"></i>
												Alertas
											</h6>
										</div>
										<div class="card-body text-center">
											<div th:if="${alertas == 0}">
												<i class="bi bi-check-circle text-success fs-1"></i>
												<p class="text-success mt-2 mb-0">Todo en orden</p>
												<small class="text-muted">Sin incidencias</small>
											</div>

											<div th:if="${alertas > 0}">
												<i class="bi bi-exclamation-triangle text-warning fs-1"></i>
												<h4 class="text-warning" th:text="${alertas}">0</h4>
												<p class="text-muted mb-3">Aprendices sin registro</p>
												<button class="btn btn-outline-warning btn-sm" id="alertas-btn">
													Ver detalles
												</button>
											</div>
										</div>
									</div>
								</div>
							</div>
						</div>
					</div>

				</div>
			</div>
		</section>

		<!-- Footer -->
		<div th:insert="~{/templates_usuario.html::footer}"></div>

	</main>

	<!-- Archivos JS -->
	<div th:insert="~{/templates_usuario.html::jsFiles}"></div>

	<!-- SweetAlert Scripts -->
	<script th:inline="javascript">
		/*<![CDATA[*/

		// Variables globales desde Thymeleaf
		const usuarioNombre = /*[[${usuario.nombre}]]*/ 'Instructor';
		const usuarioEmail = /*[[${usuario.email}]]*/ 'instructor@sena.edu.co';
		const alertasCount = /*[[${alertas}]]*/ 0;

		// Función para mostrar carga
		function cargando(mensaje) {
			if (typeof Swal !== 'undefined') {
				Swal.fire({
					title: mensaje,
					allowOutsideClick: false,
					showConfirmButton: false,
					didOpen: () => {
						Swal.showLoading();
					}
				});

				// Cierre automático tras 2 segundos
				setTimeout(() => {
					if (Swal && Swal.isVisible()) {
						Swal.close();
					}
				}, 2000);
			}
		}

		// Confirmar logout
		function confirmarLogout(event) {
			event.preventDefault();

			if (typeof Swal !== 'undefined') {
				Swal.fire({
					title: '¿Cerrar sesión?',
					text: "¿Estás seguro de que quieres salir?",
					icon: 'question',
					showCancelButton: true,
					confirmButtonColor: '#0c2d48',
					cancelButtonColor: '#6c757d',
					confirmButtonText: 'Sí, salir',
					cancelButtonText: 'Cancelar'
				}).then((result) => {
					if (result.isConfirmed) {
						window.location.href = '/logout';
					}
				});
			} else {
				// si SweetAlert no está disponible
				if (confirm('¿Estás seguro de que quieres cerrar sesión?')) {
					window.location.href = '/logout';
				}
			}
		}

		// Mostrar perfil
		function mostrarPerfil() {
			if (typeof Swal !== 'undefined') {
				Swal.fire({
					title: 'Mi Perfil',
					html: `
						<div class="text-start">
							<p><strong>Nombre:</strong> ${usuarioNombre}</p>
							<p><strong>Email:</strong> ${usuarioEmail}</p>
							<p><strong>Área:</strong> Mecánica</p>
							<p><strong>Estado:</strong> <span class="badge bg-success">Activo</span></p>
						</div>
					`,
					icon: 'info',
					confirmButtonColor: '#0c2d48',
					confirmButtonText: 'Entendido'
				});
			} else {
				alert(`Perfil:\nNombre: ${usuarioNombre}\nEmail: ${usuarioEmail}\nÁrea: Mecánica\nEstado: Activo`);
			}
		}

		function verDetallesAlertas() {
			if (typeof Swal !== 'undefined') {
				Swal.fire({
					title: 'Detalles de Alertas',
					html: `
						<div class="text-start">
							<p><strong>${alertasCount}</strong> aprendices no han registrado entrada hoy.</p>
							<p>Revisa la sección de <strong>Últimas Entradas</strong> para más detalles.</p>
						</div>
					`,
					icon: 'warning',
					confirmButtonColor: '#0c2d48',
					confirmButtonText: 'Entendido'
				});
			} else {
				alert(`${alertasCount} aprendices no han registrado entrada hoy. Revisa la sección de Últimas Entradas.`);
			}
		}

		// Inicializar eventos 
		document.addEventListener('DOMContentLoaded', function () {
			// Asignar evento al enlace de perfil
			const perfilLink = document.getElementById('perfil-link');
			if (perfilLink) {
				perfilLink.addEventListener('click', function (e) {
					e.preventDefault();
					mostrarPerfil();
				});
			}

			// Asignar evento al enlace de logout
			const logoutLink = document.getElementById('logout-link');
			if (logoutLink) {
				logoutLink.addEventListener('click', confirmarLogout);
			}

			// Asignar eventos a botones de carga
			const cargandoButtons = document.querySelectorAll('.cargando-btn');
			cargandoButtons.forEach(button => {
				button.addEventListener('click', function (e) {
					const mensaje = this.getAttribute('data-mensaje') || 'Cargando...';
					cargando(mensaje);
				});
			});

			// Asignar evento al botón de alertas
			const alertasBtn = document.getElementById('alertas-btn');
			if (alertasBtn) {
				alertasBtn.addEventListener('click', verDetallesAlertas);
			}

			// Mostrar alerta de bienvenida
			setTimeout(() => {
				if (typeof Swal !== 'undefined') {
					Swal.fire({
						title: '¡Bienvenido!',
						text: 'Panel de instructor cargado correctamente',
						icon: 'success',
						confirmButtonColor: '#0c2d48',
						timer: 5000,
						timerProgressBar: true,
						toast: true,
						position: 'top-end',
						showConfirmButton: false
					});
				}
			}, 800);
		});

		/*]]>*/
	</script>
</body>

</html>