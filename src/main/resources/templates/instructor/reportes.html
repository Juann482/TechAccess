<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org">

<head th:insert="~{/instructor/templates_instructor.html::head}">
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
	<link rel="stylesheet" th:href="@{/css/instructor.css}">
</head>

<body class="index-page">

	<!-- Video de fondo -->
	<div class="video-background">
		<div class="video-overlay"></div>
	</div>

	<!-- Para SIDEBAR en celu -->
	<button class="sidebar-toggle" id="sidebarToggle">
		<i class="bi bi-list"></i>
	</button>

	<div class="dashboard-container">
		<!-- SIDEBAR -->
		<aside class="sidebar" id="sidebar">
			<div class="sidebar-header">
				<div class="logo-container">
					<i class="bi bi-easel2-fill logo-icon"></i>
					<h2>TECH<span>ACCESS</span></h2>
				</div>
				<p>SENA - CIMM CIUDADELA</p>
			</div>

			<!-- Perfil de usuario en sidebar -->
			<div class="user-profile-sidebar">
				<div class="avatar-container">
					<img th:src="@{/images/instructor.png}" alt="Instructor" class="user-avatar">
					<span class="online-status"></span>
				</div>
				<div class="user-info text-center">
					<h4 th:text="${usuario.nombre} ?: 'Instructor'">Instructor</h4>
					<p class="user-role"><b>Área:</b> Mecánica</p>
					<span class="user-status">Activo</span>
				</div>
			</div>

			<!-- Menú de navegación -->
			<ul class="sidebar-nav">
				<li>
					<a th:href="@{/instructor/nvasEntradas}" class="cargando-btn"
						data-mensaje="Cargando últimas entradas...">
						<div class="menu-icon-container">
							<i class="bi bi-house-door"></i>
						</div>
						<span class="menu-text">Últimas Entradas</span>
						<span class="menu-badge" th:text="${entradasHoy ?: 0}">0</span>
					</a>
				</li>
				<li>
					<a th:href="@{/instructor/grupos}" class="cargando-btn" data-mensaje="Cargando grupos...">
						<div class="menu-icon-container">
							<i class="bi bi-people"></i>
						</div>
						<span class="menu-text">Grupos</span>
						<span class="menu-badge" th:text="${gruposActivos ?: 0}">0</span>
					</a>
				</li>
				<li>
					<a th:href="@{/instructor/reportes}" class="active cargando-btn"
						data-mensaje="Generando reportes...">
						<div class="menu-icon-container">
							<i class="bi bi-clipboard-data"></i>
						</div>
						<span class="menu-text">Reportes</span>
						<span class="menu-indicator">
							<i class="bi bi-chevron-right"></i>
						</span>
					</a>
				</li>
			</ul>

			<!-- Resumen rápido -->
			<div class="sidebar-summary">
				<div class="summary-header">
					<i class="bi bi-graph-up"></i>
					<h5>Resumen Hoy</h5>
				</div>
				<div class="summary-stats">
					<div class="summary-item">
						<div class="summary-info">
							<i class="bi bi-person-check summary-icon present"></i>
							<span>Presentes</span>
						</div>
						<span class="summary-value text-accent" th:text="${entradasHoy ?: 0}">0</span>
					</div>
					<div class="summary-item">
						<div class="summary-info">
							<i class="bi bi-people summary-icon total"></i>
							<span>Total</span>
						</div>
						<span class="summary-value" th:text="${totalAprendices ?: 0}">0</span>
					</div>
					<div class="summary-item">
						<div class="summary-info">
							<i class="bi bi-exclamation-triangle summary-icon alert"></i>
							<span>Alertas</span>
						</div>
						<span class="summary-value text-warning" th:text="${alertas ?: 0}">0</span>
					</div>
				</div>
			</div>
		</aside>

		<!-- CONTENIDO PRINCIPAL -->
		<main class="main-content" id="mainContent">
			<!-- Encabezado superior -->
			<header class="top-header">
				<div class="page-title">
					<div class="welcome-container">
						<h1 class="welcome-text">
							<span class="greeting">Reportes de Excusas</span>
							<span class="user-name" th:text="${usuario.nombre} ?: 'Instructor'">Instructor</span>
						</h1>
						<p class="welcome-subtitle">
							<i class="bi bi-file-earmark-text me-2"></i>
							<span th:text="${totalExcusas ?: 0} + ' excusas registradas'">0 excusas registradas</span>
						</p>
					</div>
				</div>

				<div class="header-actions">
					<!-- Búsqueda rápida -->
					<div class="search-container">
						<i class="bi bi-search search-icon"></i>
						<input type="text" class="search-input" placeholder="Buscar excusa o aprendiz...">
					</div>

					<!-- Notificaciones -->
					<div class="notification-bell" id="notificationBell">
						<i class="bi bi-bell"></i>
						<span class="notification-count" th:text="${alertas ?: 0}">0</span>
						<div class="notification-pulse"></div>
					</div>

					<!-- Usuario dropdown -->
					<div class="user-dropdown dropdown">
						<a class="d-flex align-items-center text-decoration-none" dropdown-toggle
							data-bs-toggle="dropdown">
							<div class="user-avatar-mini">
								<img th:src="@{/images/instructor.png}" alt="Instructor">
							</div>
							<div class="user-info-mini">
								<span class="user-name-mini"
									th:text="${usuario.nombre} ?: 'Instructor'">Instructor</span>
								<span class="user-role-mini">Instructor</span>
							</div>
							<i class="bi bi-chevron-down dropdown-arrow"></i>
						</a>
						<ul class="dropdown-menu dropdown-menu-end">
							<li>
								<a class="dropdown-item" href="#" id="perfil-link">
									<i class="bi bi-person me-2"></i>Mi Perfil
								</a>
							</li>
							<li>
								<a class="dropdown-item" href="#">
									<i class="bi bi-gear me-2"></i>Configuración
								</a>
							</li>
							<li>
								<hr class="dropdown-divider">
							</li>
							<li>
								<a class="dropdown-item" th:href="@{/logout}" id="logout-link">
									<i class="bi bi-box-arrow-right me-2"></i>Cerrar sesión
								</a>
							</li>
						</ul>
					</div>
				</div>
			</header>

			<!-- Widgets -->
			<div class="quick-widgets">
				<div class="quick-widget">
					<div class="widget-icon schedule">
						<i class="bi bi-file-earmark-text"></i>
					</div>
					<div class="widget-content">
						<span class="widget-value" th:text="${totalExcusas ?: 0}">0</span>
						<span class="widget-label">Total Excusas</span>
					</div>
				</div>

				<div class="quick-widget">
					<div class="widget-icon next-class">
						<i class="bi bi-person-x"></i>
					</div>
					<div class="widget-content">
						<span class="widget-value" th:text="${alertas ?: 0}">0</span>
						<span class="widget-label">Pendientes</span>
					</div>
				</div>
			</div>

			<!-- Contenido principal -->
			<div class="content-section">
				<!-- Panel de reportes -->
				<div class="section-card glassmorphism" style="grid-column: 1 / -1;">
					<div class="section-header">
						<div class="section-title">
							<div class="section-icon activity">
								<i class="bi bi-clipboard-data"></i>
							</div>
							<div>
								<h3>Reporte de Excusas</h3>
								<p class="section-subtitle">
									<span th:text="${totalExcusas ?: 0}">0</span> excusas registradas en el sistema
								</p>
							</div>
						</div>
					</div>

					<div class="section-body">
						<!-- Ponderado -->
						<div class="row mb-4">
							<div class="col-md-12">
								<div class="glassmorphism rounded p-4 text-center"
									style="background: linear-gradient(135deg, rgba(52, 152, 219, 0.2), rgba(41, 128, 185, 0.2));">
									<h1 class="text-white" th:text="${totalExcusas ?: 0}">0</h1>
									<p class="mb-0 fs-5 text-light">Registro total de Excusas en el Sistema</p>
								</div>
							</div>
						</div>

						<!-- Reporte de Excusas -->
						<div class="glassmorphism rounded p-4 mb-4">
							<div class="d-flex justify-content-between align-items-center mb-4">
								<h5 class="text-white mb-0">
									<i class="bi bi-file-earmark-text me-2"></i>Excusas de Aprendices
								</h5>
								<span class="badge bg-secondary" th:text="${totalExcusas} + ' excusas'">
									0 excusas
								</span>
							</div>

							<div th:if="${excusas.empty}" class="text-center py-5">
								<div class="empty-state">
									<div class="empty-icon">
										<i class="bi bi-file-earmark-x text-muted"></i>
									</div>
									<h4 class="text-muted">No hay excusas registradas</h4>
									<p class="text-muted">No se encontraron excusas en el sistema</p>
								</div>
							</div>

							<div th:unless="${excusas.empty}">
								<!-- Paginación -->
								<nav th:if="${totalPaginas > 1}" class="mb-4">
									<ul class="pagination justify-content-center">
										<!-- PREVIOUS -->
										<li class="page-item" th:classappend="${paginaActual == 0} ? 'disabled' : ''">
											<a class="page-link glassmorphism border-0 text-light"
												th:href="@{/instructor/reportes(page=${paginaActual - 1})}">
												&laquo; Anterior
											</a>
										</li>

										<!-- Páginas -->
										<li th:each="i : ${#numbers.sequence(0, totalPaginas - 1)}" class="page-item"
											th:classappend="${i == paginaActual} ? 'active' : ''">
											<a class="page-link glassmorphism border-0"
												th:classappend="${i == paginaActual} ? 'bg-primary text-white' : 'text-light'"
												th:href="@{/instructor/reportes(page=${i})}" th:text="${i + 1}">
											</a>
										</li>

										<!-- NEXT -->
										<li class="page-item"
											th:classappend="${paginaActual == totalPaginas - 1} ? 'disabled' : ''">
											<a class="page-link glassmorphism border-0 text-light"
												th:href="@{/instructor/reportes(page=${paginaActual + 1})}">
												Siguiente &raquo;
											</a>
										</li>
									</ul>
								</nav>

								<!-- Info de paginación -->
								<div class="text-center text-muted mb-4">
									<small>
										Página <span class="text-light" th:text="${paginaActual + 1}"></span>
										de <span class="text-light" th:text="${totalPaginas}"></span>
										| Mostrando <span class="text-light" th:text="${excusas.size()}"></span> excusas
									</small>
								</div>

								<!-- Tabla de Excusas -->
								<div class="table-responsive">
									<table class="table table-hover align-middle mb-0" style="color: white;">
										<thead style="background: rgba(12, 45, 72, 0.7);">
											<tr>
												<th>ID</th>
												<th>Motivo</th>
												<th>Descripción</th>
												<th>Fecha</th>
												<th>Aprendiz</th>
												<th>Ficha</th>
												<th>Soporte</th>
											</tr>
										</thead>
										<tbody>
											<tr th:each="excusa : ${excusas}"
												style="border-color: rgba(255, 255, 255, 0.1);">
												<td class="fw-medium" th:text="${excusa.id}">1</td>
												<td>
													<span th:text="${excusa.motivo}" class="fw-bold text-light">
														Enfermedad
													</span>
												</td>
												<td>
													<small th:text="${excusa.descripcion}" class="text-muted"
														style="max-width: 200px; display: inline-block; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">
														Descripción de la excusa...
													</small>
												</td>
												<td th:text="${#temporals.format(excusa.fecha, 'dd/MM/yyyy')}">
													15/04/2024
												</td>
												<td>
													<span th:if="${excusa.usuario != null}"
														th:text="${excusa.usuario.nombre}" class="fw-bold text-light">
														Aprendiz
													</span>
													<span th:if="${excusa.usuario == null}"
														class="text-muted fst-italic">
														Sin aprendiz
													</span>
												</td>
												<td>
													<span th:if="${excusa.ficha != null}"
														th:text="${excusa.ficha.numFicha}"
														class="badge bg-primary bg-opacity-25 text-primary border border-primary">
														2557863
													</span>
													<span th:if="${excusa.ficha == null}" class="text-muted fst-italic">
														Sin ficha
													</span>
												</td>
												<td>
													<span th:if="${excusa.soporte != null and excusa.soporte != ''}">
														<a th:href="@{'/uploads/' + ${excusa.soporte}}" target="_blank"
															class="badge bg-success bg-opacity-25 text-success border border-success">
															<i class="bi bi-file-earmark-arrow-down me-1"></i>Ver
														</a>
													</span>
													<span th:if="${excusa.soporte == null or excusa.soporte == ''}"
														class="badge bg-info bg-opacity-25 text-info border border-info">
														<i class="bi bi-file-x me-1"></i>Sin soporte
													</span>
												</td>
											</tr>
										</tbody>
									</table>
								</div>
							</div>
						</div>

						<!-- Estadísticas -->
						<div class="glassmorphism rounded p-4">
							<div class="mb-4">
								<h6 class="text-white mb-0">
									<i class="bi bi-pie-chart me-2"></i>Estadísticas de Excusas
								</h6>
							</div>

							<div th:if="${!excusas.empty}">
								<div class="row text-center">
									<div class="col-md-3 mb-3">
										<div class="glassmorphism rounded p-3">
											<h4 class="text-white"
												th:text="${#lists.size(excusas.?[motivo == 'ENFERMEDAD'])}">0</h4>
											<span class="badge bg-info bg-opacity-25 text-info border border-info">
												ENFERMEDAD
											</span>
										</div>
									</div>
									<div class="col-md-3 mb-3">
										<div class="glassmorphism rounded p-3">
											<h4 class="text-white"
												th:text="${#lists.size(excusas.?[motivo =='CITA MÉDICA'])}">0</h4>
											<span
												class="badge bg-secondary bg-opacity-25 text-light border border-secondary">
												CITA MÉDICA
											</span>
										</div>
									</div>
									<div class="col-md-3 mb-3">
										<div class="glassmorphism rounded p-3">
											<h4 class="text-white"
												th:text="${#lists.size(excusas.?[motivo =='EMERGENCIA FAMILIAR'])}">0
											</h4>
											<span class="badge bg-info bg-opacity-25 text-info border border-info">
												EMERGENCIA FAMILIAR
											</span>
										</div>
									</div>
									<div class="col-md-3 mb-3">
										<div class="glassmorphism rounded p-3">
											<h4 class="text-white"
												th:text="${#lists.size(excusas.?[motivo == 'OTRO'])}">0</h4>
											<span
												class="badge bg-secondary bg-opacity-25 text-light border border-secondary">
												OTRO
											</span>
										</div>
									</div>
								</div>
							</div>
							<div th:if="${excusas.empty}" class="text-center">
								<p class="text-muted">No hay datos para mostrar estadísticas</p>
							</div>
						</div>
					</div>
				</div>
			</div>
		</main>
	</div>

	<!-- Footer -->
	<div th:insert="~{/templates_usuario.html::footer}"></div>

	<!-- Archivos JS -->
	<div th:insert="~{/templates_usuario.html::jsFiles}"></div>

	<!-- SweetAlerts Scripts -->
	<script th:inline="javascript">
		/*<![CDATA[*/
		// Variables globales desde Thymeleaf
		const usuarioNombre = /*[[${usuario.nombre}]]*/ 'Instructor';
		const usuarioEmail = /*[[${usuario.email}]]*/ 'instructor@sena.edu.co';
		const alertasCount = /*[[${alertas}]]*/ 0;
		const totalAprendices = /*[[${totalAprendices}]]*/ 0;
		const totalExcusasCount = /*[[${totalExcusas}]]*/ 0;

		// Toggle sidebar en móvil
		const sidebarToggle = document.getElementById('sidebarToggle');
		const sidebar = document.getElementById('sidebar');
		const mainContent = document.getElementById('mainContent');

		if (sidebarToggle && sidebar) {
			sidebarToggle.addEventListener('click', function (e) {
				e.stopPropagation();
				sidebar.classList.toggle('active');
			});

			// Cerrar sidebar al hacer clic fuera en móvil
			document.addEventListener('click', function (event) {
				if (window.innerWidth <= 768 &&
					sidebar.classList.contains('active') &&
					!sidebar.contains(event.target) &&
					!sidebarToggle.contains(event.target)) {
					sidebar.classList.remove('active');
				}
			});
		}

		// Función para mostrar carga
		function cargando(mensaje) {
			if (typeof Swal !== 'undefined') {
				Swal.fire({
					title: mensaje,
					allowOutsideClick: false,
					showConfirmButton: false,
					backdrop: 'rgba(0, 0, 0, 0.4)',
					didOpen: () => {
						Swal.showLoading();
					}
				});

				// Cierre automático tras 2 segundos
				setTimeout(() => {
					if (Swal && Swal.isVisible()) {
						Swal.close();
					}
				}, 2000);
			}
		}

		// Confirmar logout
		function confirmarLogout(event) {
			event.preventDefault();

			if (typeof Swal !== 'undefined') {
				Swal.fire({
					title: '¿Cerrar sesión?',
					text: "¿Estás seguro de que quieres salir del sistema?",
					icon: 'question',
					showCancelButton: true,
					confirmButtonColor: '#0c2d48',
					cancelButtonColor: '#6c757d',
					confirmButtonText: 'Sí, salir',
					cancelButtonText: 'Cancelar',
					backdrop: 'rgba(0, 0, 0, 0.4)'
				}).then((result) => {
					if (result.isConfirmed) {
						window.location.href = '/logout';
					}
				});
			} else {
				if (confirm('¿Estás seguro de que quieres cerrar sesión?')) {
					window.location.href = '/logout';
				}
			}
		}

		// Mostrar perfil
		function mostrarPerfil() {
			if (typeof Swal !== 'undefined') {
				Swal.fire({
					title: 'Mi Perfil',
					html: `
                        <div class="profile-modal">
                            <div class="profile-header">
                                <img src="/images/instructor.png" alt="Instructor" class="profile-avatar">
                                <div class="profile-status online"></div>
                            </div>
                            <div class="profile-info">
                                <div class="info-item">
                                    <i class="bi bi-person"></i>
                                    <div>
                                        <span class="info-label">Nombre</span>
                                        <span class="info-value">${usuarioNombre}</span>
                                    </div>
                                </div>
                                <div class="info-item">
                                    <i class="bi bi-envelope"></i>
                                    <div>
                                        <span class="info-label">Email</span>
                                        <span class="info-value">${usuarioEmail}</span>
                                    </div>
                                </div>
                                <div class="info-item">
                                    <i class="bi bi-briefcase"></i>
                                    <div>
                                        <span class="info-label">Área</span>
                                        <span class="info-value">Mecánica</span>
                                    </div>
                                </div>
                                <div class="info-item">
                                    <i class="bi bi-file-earmark-text"></i>
                                    <div>
                                        <span class="info-label">Excusas Registradas</span>
                                        <span class="info-value">${totalExcusasCount}</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `,
					icon: 'info',
					confirmButtonColor: '#0c2d48',
					confirmButtonText: 'Entendido',
					backdrop: 'rgba(0, 0, 0, 0.4)',
					showCloseButton: true
				});
			} else {
				alert(`Perfil:\nNombre: ${usuarioNombre}\nEmail: ${usuarioEmail}\nÁrea: Mecánica\nExcusas: ${totalExcusasCount}`);
			}
		}

		// Inicializar eventos
		document.addEventListener('DOMContentLoaded', function () {
			// Asignar evento a enlaces de perfil
			const perfilLink = document.getElementById('perfil-link');
			if (perfilLink) {
				perfilLink.addEventListener('click', function (e) {
					e.preventDefault();
					mostrarPerfil();
				});
			}

			// Asignar evento a enlaces de logout
			const logoutLink = document.getElementById('logout-link');
			if (logoutLink) {
				logoutLink.addEventListener('click', confirmarLogout);
			}

			// Asignar eventos a botones de carga
			const cargandoButtons = document.querySelectorAll('.cargando-btn');
			cargandoButtons.forEach(button => {
				button.addEventListener('click', function (e) {
					const mensaje = this.getAttribute('data-mensaje') || 'Cargando...';
					cargando(mensaje);
				});
			});

			// Mostrar alerta de bienvenida
			setTimeout(() => {
				if (typeof Swal !== 'undefined' && totalExcusasCount > 0) {
					Swal.fire({
						title: 'Reportes Cargados',
						text: `Se han cargado ${totalExcusasCount} excusas registradas.`,
						icon: 'success',
						confirmButtonColor: '#0c2d48',
						timer: 3000,
						timerProgressBar: true,
						toast: true,
						position: 'top-end',
						showConfirmButton: false,
						backdrop: false
					});
				}
			}, 1000);

			// Efecto de aparición para las tarjetas
			const statCards = document.querySelectorAll('.stat-card, .glassmorphism');
			statCards.forEach((card, index) => {
				setTimeout(() => {
					card.style.opacity = '1';
					card.style.transform = 'translateY(0)';
				}, index * 100);
			});
		});
		/*]]>*/
	</script>
</body>

</html>